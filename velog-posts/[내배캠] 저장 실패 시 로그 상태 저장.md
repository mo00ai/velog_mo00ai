<h2 id="ìš”êµ¬ì‚¬í•­">ìš”êµ¬ì‚¬í•­</h2>
<p>ğŸ‘‰ ë§¤ë‹ˆì € ë“±ë¡ ìš”ì²­ ì‹œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ì‹¶ì–´ìš”!
<code>@Transactional</code>ì˜ ì˜µì…˜ ì¤‘ í•˜ë‚˜ë¥¼ í™œìš©í•˜ì—¬ ë§¤ë‹ˆì € ë“±ë¡ê³¼ ë¡œê·¸ ê¸°ë¡ì´ ê°ê° ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬ë  ìˆ˜ ìˆë„ë¡ í•´ë´…ì‹œë‹¤.</p>
<ul>
<li>ë§¤ë‹ˆì € ë“±ë¡ ìš”ì²­ì„ ê¸°ë¡í•˜ëŠ” ë¡œê·¸ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.<ul>
<li>DB í…Œì´ë¸”ëª…: <code>log</code></li>
</ul>
</li>
<li>ë§¤ë‹ˆì € ë“±ë¡ê³¼ëŠ” ë³„ê°œë¡œ ë¡œê·¸ í…Œì´ë¸”ì—ëŠ” í•­ìƒ ìš”ì²­ ë¡œê·¸ê°€ ë‚¨ì•„ì•¼ í•´ìš”.<ul>
<li>ë§¤ë‹ˆì € ë“±ë¡ì€ ì‹¤íŒ¨í•  ìˆ˜ ìˆì§€ë§Œ, ë¡œê·¸ëŠ” ë°˜ë“œì‹œ ì €ì¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
<li>ë¡œê·¸ ìƒì„± ì‹œê°„ì€ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.</li>
<li>ê·¸ ì™¸ ë¡œê·¸ì— ë“¤ì–´ê°€ëŠ” ë‚´ìš©ì€ ì›í•˜ëŠ” ì •ë³´ë¥¼ ììœ ë¡­ê²Œ ë„£ì–´ì£¼ì„¸ìš”.</li>
</ul>
</li>
</ul>
<hr />
<pre><code class="language-java">@Getter
@Entity
@NoArgsConstructor
@Table(name = &quot;logs&quot;)
public class Log {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY) // ì¼ì • id
    @JoinColumn(name = &quot;manager_id&quot;, nullable = false)
    private Manager manager;

    @Column(nullable = false)
    private Boolean isFailed;

    @Column(nullable = false)
    private LocalDateTime time;

    public Log(Manager manager, Boolean isFailed) {
        this.manager = manager;
        this.isFailed = isFailed;
        this.time = LocalDateTime.now();
    }
}</code></pre>
<p>ë§¤ë‹ˆì € ë“±ë¡ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸ ì €ì¥í•˜ëŠ” í…Œì´ë¸” ì—”í‹°í‹°
ë‚˜ëŠ” ìš”êµ¬ì‚¬í•­ì— ì¶”ê°€í•´ì„œ <code>isFailed</code> -&gt; ì‹¤íŒ¨ì—¬ë¶€ Boolean í•„ë“œë„ ì¶”ê°€í•´ì¤¬ë‹¤</p>
<p>ì´ ë•Œë¬¸ì— ì¢€ ìƒê°í• ê²Œ ë§ì•˜ë‹¤</p>
<blockquote>
<p>í•˜ì§€ë§Œ TILì„ ì“¸ ìˆ˜ ìˆê²Œ ë˜ì§€^^</p>
</blockquote>
<hr />
<pre><code class="language-java">        try {

            Manager savedManagerUser = managerRepository.save(newManagerUser);

            logService.saveLog(savedManagerUser,false);

            return new ManagerSaveResponse(
                savedManagerUser.getId(),
                new UserResponse(managerUser.getId(), managerUser.getEmail())
            );

        } catch (Exception e) {

            logService.saveLog(newManagerUser, true);

            throw new ManagerException(&quot;ë§¤ë‹ˆì € ë“±ë¡ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.&quot;);

        }</code></pre>
<p>ìš°ì„  ë‚˜ëŠ” ë§¤ë‹ˆì € íŒ¨í‚¤ì§€ì™€ ë¡œê·¸ íŒ¨í‚¤ì§€ë¥¼ ë„ë©”ì¸ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì„œ ê°œë°œí–ˆë‹¤
ê·¸ë¦¬ê³  </p>
<pre><code class="language-java">    @Transactional
    public ManagerSaveResponse saveManager(CustomUserPrincipal userPrincipal, long todoId, ManagerSaveRequest managerSaveRequest) {

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveLog(Manager manager, boolean isFailed) {
</code></pre>
<p>ì´ì²˜ëŸ¼ manager save Serviceì—ëŠ” ì¼ë°˜ Transactional
log save ServiceëŠ” REQUIRES_NEWë¥¼ ì‚¬ìš©í•´ì„œ ìƒìœ„ íŠ¸ëœì­ì…˜ì— í¬í•¨ë˜ì§€ ì•Šê³  ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ì„ íƒˆ ìˆ˜ ìˆë„ë¡ í–ˆë‹¤</p>
<blockquote>
<p>ë¡œê·¸ ìƒì„±ì€ ë§¤ë‹ˆì € ìƒì„±ê³¼ ë‹¤ë¥´ê²Œ í•­ìƒ ì‹¤íŒ¨í•˜ë“ , ì„±ê³µí•˜ë“  í•­ìƒ ì €ì¥ë˜ì–´ì•¼ í•˜ê¸°ì— ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ì„ ë¶€ì—¬í•¨</p>
</blockquote>
<hr />
<pre><code class="language-java">        try {

            Manager savedManagerUser = managerRepository.save(newManagerUser);

            logService.saveLog(savedManagerUser,false);

            return new ManagerSaveResponse(
                savedManagerUser.getId(),
                new UserResponse(managerUser.getId(), managerUser.getEmail())
            );

        } catch (Exception e) {

            logService.saveLog(newManagerUser, true);

            throw new ManagerException(&quot;ë§¤ë‹ˆì € ë“±ë¡ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.&quot;);

        }</code></pre>
<p>ê·¸ë¦¬ê³  manager Serviceì—ì„  íŠ¸ë¼ì´ìºì¹˜ë¡œ ê°ì‹¸ì¤¬ë‹¤ </p>
<blockquote>
<p>ë§¤ë‹ˆì € ì €ì¥ ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ë¡œì§ì„ ìˆ˜í–‰í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì—</p>
</blockquote>
<ul>
<li>Logì˜ isFailed ê°’ì— trueë¥¼ ì ìš©í•´ì¤˜ì•¼í•¨ ì„±ê³µí•  ë• falseê³ </li>
</ul>
<br />

<p>ê·¸ë˜ì„œ íŠ¸ë¼ì´ ìºì¹˜ë¡œ ê°ìŒŒëŠ”ë° ê³ ë ¤í•´ì•¼í•  ë¶€ë¶„ì´ ëª‡ ê°€ì§€ ìˆì—ˆìŒ</p>
<br />

<p>ğŸ¤” ì˜ˆì™¸ë¥¼ ë˜ì ¸ì•¼ í•˜ëŠ”ë° ì–´ë–¤ê±¸ ë˜ì ¸ì•¼ í•˜ì§€?</p>
<ul>
<li>ë³´í†µ ì—¬íƒœê¹Œì§€ëŠ” íŠ¸ë¼ì´ ìºì¹˜ë¬¸ ì—†ì´ CustomExceptionì„ ë‚ ë ¸ëŠ”ë°
catchì—ì„œ ì–´ë–¤ ì˜ˆì™¸ë¥¼ ìºì¹˜í•´ì¤˜ì•¼í• ì§€ ëª¨ë¥´ê² ì—ˆìŒ</li>
</ul>
<blockquote>
<p>ì˜ˆì™¸ëŠ” ê°€ì¥ í° ë‹¨ìœ„ë¡œ ì¡ëŠ”ë‹¤. ë¬´ìŠ¨ ì˜ˆì™¸ê°€ í„°ì§ˆ ì§€ ëª¨ë¥´ë‹ˆê»˜
-&gt; ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ì— catch ë§ˆì§€ë§‰ì— CustomExceptionì„ ë˜ì ¸ì¤˜ì„œ ë¡¤ë°± ì‹œí‚¨ë‹¤
-&gt; ì™œëƒë©´ íŠ¸ë¼ì´ ìºì¹˜ë¡œ ì˜ˆì™¸ í„°ì§€ëŠ” ë¶€ë¶„ì„ ê°ì‹¸ë©´ ì˜ˆì™¸ê°€ í„°ì ¸ë„ íŠ¸ë¼ì´ ìºì¹˜ë•Œë¬¸ì— ë¡¤ë°±ì´ ì•ˆë¨. ê·¸ë˜ì„œ ì˜ˆì™¸ë¥¼ ë˜ì ¸ì¤˜ì•¼í•¨</p>
</blockquote>
<p>ì •ë¦¬</p>
<ol>
<li>REQUIRES_NEWë¡œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬í•¨</li>
</ol>
<p>-&gt; ë§¤ë‹ˆì € ë“±ë¡ ì‹¤íŒ¨í•˜ë”ë¼ë„ ë¡œê·¸ ìƒì„±ì€ ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ ë‘˜ì€ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ë‹ˆê¹Œ
2. try-catchë¡œ ë§¤ë‹ˆì € ë“±ë¡ ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼ ë‹¤ë¥¸ ë¡œê·¸(isFailed)ìƒì„±
3. throw newë¡œ Custom ì˜ˆì™¸ ë‚ ë ¤ì„œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ê¸°</p>
<br />

<p>â€¼ï¸ì•„ì§ ê³ ë ¤í•´ì•¼í•  ì ì´ ë‚¨ì•„ìˆìŒ</p>
<p>í˜„ì¬ catchí•˜ëŠ” ì˜ˆì™¸ëŠ” Exception ì„
ìš”êµ¬ì‚¬í•­ì— íŠ¹ì • ì˜ˆì™¸ë¥¼ ëª…ì‹œí•˜ì§€ ì•Šê³ 
ì–´ë–¤ ì´ìœ ë¡œë“  ë§¤ë‹ˆì € ë“±ë¡ì— ì‹¤íŒ¨í•´ë„ ë¡œê·¸ë¥¼ ë‚¨ê²¨ì•¼í•˜ê¸°ì— Exception ì‚¬ìš©
-&gt; êµ¬ì²´ì ì¸ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•´ì•¼í•œë‹¤ë©´ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ì¢‹ì„ê¹Œ?
-&gt; ì˜ˆë¥¼ ë“¤ì–´ ë‚˜ëŠ” ë§¤ë‹ˆì € ì •ë³´ ë‚´ íˆ¬ë‘ ì •ë³´ê°€ ì˜ëª»ë¼ì„œ ì˜ˆì™¸ë¥¼ ë‚ ë¦¬ê³  ì‹¶ì€ë°, ì‹¤ì œ ë‚ ë ¤ì§€ëŠ” ì˜ˆì™¸ëŠ” ìœ ì € ì •ë³´ê°€ ì˜ëª» ëœê±°ë¼ë©´?
-&gt; ê·¼ë° ë‘˜ ë‹¤ ì–´ì¨Œë“  Exceptionì˜ ìƒì†ì„ ë°›ì•„ì„œ ê°™ì´ ì²˜ë¦¬ë¨. ê·¸ëŸ¼ ë‘˜ ë‹¤ ë™ì¼í•œ ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ë‚ ë¦¬ë©´ ì˜ëª» ëœ ê±° ì•„ë‹Œê°€?</p>
<blockquote>
<p>ë°¤ì— ì´ëŸ° ìƒê°ì´ ë“¤ì–´ì„œ ì±—ì§€í”¼í‹°ì—ê²Œ ë¬¼ì–´ë´¤ìŠµë‹ˆë‹¤ìš” ã…‹
ë‚¼ íŠœí„°ë‹˜ê»˜ ì—¬ì­¤ë´ì•¼ì§€ ã…‹</p>
</blockquote>
<br />

<p>ì•„ì£¼ ì¤‘ìš”í•œ ë³¸ì§ˆì„ ì§šì—ˆì–´. ì´ê²Œ ë°”ë¡œ â€œì˜ˆì™¸ ì •ë³´ì˜ ì •í™•ì„± ìœ ì§€â€ì™€ â€œcatch ë²”ìœ„ ê´€ë¦¬â€ ì‚¬ì´ì˜ <code>trade-off</code> ë¬¸ì œì•¼. í•˜ë‚˜ì”© í’€ì–´ì¤„ê²Œ.</p>
<p>ğŸ”¥ ë¬¸ì œ ìš”ì•½</p>
<p><code>ìƒí™©</code>
catch (Exception e)ë¡œ ëª¨ë“  ì˜ˆì™¸ë¥¼ í†µí•©ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ë ¤ê³  í–ˆëŠ”ë°
ì‹¤ì œ ì˜ˆì™¸ëŠ” ë‹¤ì–‘í•œ ìœ„ì¹˜ì—ì„œ ë‹¤ë¥´ê²Œ ë°œìƒí•  ìˆ˜ ìˆìŒ (ì˜ˆ: User ì—†ìŒ, Todo ì—†ìŒ, DB ì˜¤ë¥˜ ë“±)
ê·¸ëŸ°ë° catch ì•ˆì—ì„œ ë˜ì§€ëŠ” ì˜ˆì™¸ëŠ” ë‹¨ì¼ ì˜ë¯¸ë¡œ ê³ ì •ë¨</p>
<p>ì˜ˆ: throw new ManagerCreateFailedException(...)</p>
<p>ğŸ‘‰ ê²°êµ­ ì‹¤ì œ ì˜¤ë¥˜ ì›ì¸ê³¼ ë‹¤ë¥¸ ì˜ˆì™¸ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•  ìœ„í—˜ì´ ìƒê¹€</p>
<blockquote>
<p>ì´ëŸ¬ê³  ì§€í”¼í‹°ê°€ ë‹¤ì–‘í•œ ë°©ë²•ì„ ì¶”ì²œí•´ì¤¬ëŠ”ë° ê²°êµ­ ë‚´ìš©ì€
ë‹ˆê°€ ì—ëŸ¬ë‚  ìƒí™©ì„ ë‹¤ íŒŒì•…í•˜ê³  ì—ëŸ¬ë³„ catchë¬¸ì„ ëª…í™•í•˜ê²Œ ì¼ì¼ì´ ì¡ì•„ì£¼ë¼ëŠ” ê±°ì˜€ìŒ^^</p>
</blockquote>
<pre><code class="language-java">// ì˜ˆì™¸ í„°ì§€ë©´ ê·¸ëŒ€ë¡œ ë˜ì ¸ë„ ë˜ëŠ” ë¶€ë¶„
User user = userRepository.findById(...).orElseThrow(() -&gt; new InvalidRequestException(...));
Todo todo = ... // ë™ì¼

try {
    Manager saved = managerRepository.save(new Manager(...));
    logService.saveLog(saved, false);
    return new ManagerSaveResponse(...);
} catch (DataAccessException e) {
    logService.saveLog(newManagerUser, true);
    throw new ManagerCreateFailedException(&quot;ë§¤ë‹ˆì € ì €ì¥ ì‹¤íŒ¨&quot;, e);
}</code></pre>
<br />

<blockquote>
<p><a href="https://minjooig.tistory.com/142">https://minjooig.tistory.com/142</a>
ì°¸ê³  ë¸”ë¡œê·¸</p>
</blockquote>